# Настройка интеграции Asterisk + FreePBX c amoCRM при помощи сервиса Callbee

Для подключения интеграции, необходимо поочередно выполнить пункты
данного руководства, в той последовательности как они описаны. 1.
Настройка Asterisk + FreePBX.

Asterisk + FreePBX далее АТС. !Требования: Asterisk версии 13.*.* +;
FreePBX версии 13.*.* +.

! Важно: • Внутренние номера(«Extensions») должны быть трехзначными
(напривер: 248). • На всех входящих маршрутах(«Inbound Routes»)
ожидаемый входящий номер DID должен быть не менее 5 цифр, это может быть
номер линии в международном формате(например: +375291111111). • На всех
входящих(«Inbound Routes») и исходящих маршрутах(«Outbound Routes»)
должны быть включены записи разговоров. • Сервис Callbee не изменят
входящий номер телефона. Входящий номер телефона будет проброшен в
amoCRM том виде в каком он поступил на АТС.(Рекомендуется средствами АТС
приводить все входящие номера телефонов к единому формату). • При звонке
по клику из AmoCRM на АТС поступает номер телефона в международном
формате. • Для корректной работы интеграции настройки на АТС которые не
указаны в данной инструкции мы рекомендуем оставить по умолчанию. •
Интеграция не работает с модулем FreePBX «Ring Groups», вместо «Ring
Groups» необходимо использовать «Queues»

Интеграция осуществляется при помощи подключения облачного сервиса
Callbee к Астериску при помощи Asterisk Managment Interface (AMI)
посредством TCP протокола. AMI принимает подключения, устанавливаемые на
сетевой порт (по умолчанию - TCP порт 5038)

Сетевые настройки:

Для того чтобы сервис Callbee мог подключится к вашей АТС, у вас
обязательно должен быть «белый» статический IP адрес либо доменное имя с
A записью на ваш IP адрес, и проброшены через NAT к АТС следующие два
порта: • внешний порт (например 35038) на порт 5038 TCP: для доступа к
АТС по AMI (Замечание по безопасности! Рекомендуем открывать порт
разрешив подключение с IP адреса источника 89.108.65.246 (сallbee.io)) •
внешний порт (например 38080) на порт 80 TCP (стандартный порт веб -
сервера АТС) - для выгрузки записей разговоров

Интерфейс настройки проброса портов сильно отличается в зависимости от
используемого в вашей сети маршрутизатора. Актуальную инструкцию по
пробросу портов под ваш маршрутизатор вы можете найти в интернете.

1.1 Настройка AMI Asterisk:

Создать можно двумя способами:

Способ 1 через CLI: В файл /etc/asterisk/manager\_custom.conf добавить
[callbee] secret = (например YrQyvYimHYTHuCQoJAbyUe1aiKumLi)
deny=0.0.0.0/0.0.0.0 permit=127.0.0.1/255.255.255.0
permit=89.108.65.246/255.255.255.255
read=system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message
write=system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message
writetimeout = 500

Выполнить команду «asterisk -rx "manager reload"»

Способ 2 через интерфейс FreePBX:

    • должен быть установлен модуль Asterisk API;
    • выбрать меню «Settings»(1) - выбрать «Asterisk Manager Users»(2);  










    • во вкладке «General» указать имя учетной записи, задать криптостойкий пароль и добавить доступ в пункт «Permit», указав IP адрес сервера Callbee 89.108.65.246, к AMI-интерфейсу;  

    • во вкладке «Permissions» установить все переключатели в положение «Yes» 

1.2 Включение «CEL(Channel event logging)»на АТС:

Дополнительно необходимо включить события на канале «CEL»

/etc/asterisk/cel\_general\_custom.conf

[manager] enabled = yes

1.3 Настройка «Входящей маршрутизации(Inbound Routes)» в FreePBX:

Пример стандартной настройки:

Выставить задержку на маршрутах, для определения контакта в amoCRM:
Advanced -\> Pause Before Answer (например 3 сек)

Включаем записи разговоров на маршрутах: Other -\> Call Recording «Yes»

1.4 Настройка «Внутренних номеров(Extensions)» в FreePBX:

Пример: настройки внутреннего номера 208 ! Важно: • Внутренние
номера(«Extensions») должны быть трехзначными (например: 208). •
«Outbound CID» оставить по умолчанию. • Внутренние номера необходимо
настраивать с использованием драйвера Chan\_SIP.

    • настройку записей разговоров оставить по умолчанию(записи записываются на маршрутах) 

2.Подключение интеграции на стороне сервиса Callbee.

После проведения всех настроек описанных выше необходимо произвести
подключения сервиса.

2.1 В личном кабинете сервиса Callbee для интеграции с AmoCRM
необходимо:

I. Во вкладке "Integration" нажить на кнопку «Install integration» и
выбрать вкладку "amoCRM with Asterisk" либо нажать кнопку "Install" на
блоке с типом интеграции "amoCRM with Asterisk".

II. Заполнить все необходимые пункты для интеграции.

В поле amoCRM Domain обязательно необходимо внести ваш домен amoCRM
(например, callbee.amocrm.ru без https://). amoCRM TOKEN - Токен для
соединения с AmoCRM, этот токен необходимо будет вставить в интеграцию
на стороне AmoCRM (токен должен быть из 12 символов, правее есть
кнопка генерации токена). Настройка интеграции на стороне AmoCRM описана
далее. Google Chrome TOKEN - Токен для соединения с расширением в
браузере Google Chrome, этот токен необходимо будет вставить в
параметрах расширения (токен должен быть из 12 символов, правее есть
кнопка генерации токена). Настройка расширения описана далее. Asterisk
AMI Host/Port/Username/Secret - Настройка подключения по AMI к ATC
(IP-адрес сервера или доменное имя, порт, имя пользователя, пароль).
Record URL - Ссылка для записей разговоров (ссылка пробрасывается в CRM
систему). Ignore lines (DID) numbers - DID номер(а) через запятую на
входящим маршруте (интеграция будет игнорировать эти входящие маршруты).
Outgoing calls (all lines) - При исходящем звонке создавать
«Неразобранное», «Контакт», «Контакт + Сделка».

Далее указываются настройки для линии (DID). В стандартной версии
настройки применяются ко всем линиям по умолчанию. В Pro версии есть
возможность устанавливать настройки для каждой линии индивидуально.

Line (DID) - Номер подразделения отдела; номер для входящих звонков,
который относится к подразделению/отделу (номер берется из настроек
FreePBX поля DID и доступно для редактирования только в Pro версии).
*Скриншот из FreePBX*

Description - Описание линии (DID) будет заполнять поле "Линия" в
карточке Контакта и Сделки, если оставить поле Description пустым, будет
проброшен номер линии (DID) (доступно для редактирования только в Pro
версии). amoCRM pepline - Воронка в amoCRM. На момент создания
интеграции по умолчанию выбирается основная воронка (Main), т.к. еще нет
связи интеграции и amoCRM. Далее при корректном подключении интеграции
при редактировании можно будет указать необходимую воронку из
имеющихся.  amoCRM user ID for missed calls - ID пользователя в AmoCRM
для пропущенных вызовов (ответственный пользователь за пропущенные
вызовы для новых клиентов, которых нет в AmoCRM, например).

Smart call (by time) - Включение умной маршрутизации (перевод звонка на
ответственного сотрудника) с указанием времени работы. Incoming
call - При входящем звонке создавать «Неразобранное», «Контакт»,
«Контакт + Сделка». Unsorted during a phone call - Создание
неразобранного в AmoCRM в момент ответа на входящий звонок. Repeat sales
mode - Настройка автоматической регистрации повторных сделок. При
повторном обращении клиента в поле "Повторное обращение" будет указано
значение "Повторное". Если данная настройка отключена, поле "Повторное
обращение" можно скрыть.

III. Нажать кнопку « Save» и дождаться завершения подключения.

3.Подключение интеграции на стороне AmoCRM.

4.1 В настройках AmoCRM, выбрать пункт «Интеграции», в разделе
    «Телефония» найти интеграцию «Callbee», согласившись с условиями
    нажать на кнопку «Установить»

5.2  Далее необходимо прописать внутренние номера сотрудников. 3.3 В
    поле «Callbee токен» указать уникальный токен скопировав из личного
    кабинета «Callbee»

6.4 Интеграция будет работать только для внутренних номеров, которые
    вы указали у сотрудников.

7.5 Сохранить настройки.

8.7 В личном кабинете сервиса «Callbee» после всех настроек на стороне
    AmoCRM необходимо перезагрузить интеграцию.

9.Подключение и настройка расширения в браузере Google Chrome

Расширение «Callbee» в google chrome используется для оповещения
сотрудника о поступающих вызовах.

4.1 Установка: В магазине google chrome находим расширение «Callbee» и
устанавливаем его.

4.2 Настройка:

    1. Отметить пункт «New version» (обязательно).
    2. Переход в карточку контакта по клику в новой вкладке браузера.
    3. Внутренний номер телефона сотрудника.
    4. Уникальный токен и личного кабинета «Callbee» 

     5. Сохраняем настройки.

4.3 Статус расширения:

«ON» - работает умная маршрутизация, отображаются оповещения

«OFF» - отключены все оповещения, не работает умная маршрутизация

На данном этапе настройка считается выполненной.
