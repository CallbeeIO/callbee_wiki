# Настройка интеграции Asterisk + FreePBX c amoCRM при помощи сервиса Callbee

<sub><sup>Для подключения интеграции, необходимо поочередно выполнить пункты
данного руководства, в той последовательности как они описаны.</sup></sub>

## Необходимые требования

Asterisk + FreePBX далее АТС

* Asterisk с версии 13.\*.\*
* FreePBX с версии 13.\*.\*
* Статический IP адрес для АТС (необходимо приобрести у вашего интернет-провайдера)

## Настройка Asterisk + FreePBX

!!! info

    * Внутренние номера (Extensions) могут быть трехзначными или четырехзначными (222 или 2222).
    * На всех входящих маршрутах(Inbound Routes) ожидаемый входящий номер DID должен быть не менее 5 цифр, это может быть номер линии в международном формате (например: +375291111111).
    * На всех входящих (Inbound Routes) и исходящих маршрутах (Outbound Routes) обязательно должны быть включены записи разговоров.
    * Сервис Callbee не изменят входящий номер телефона. Входящий номер телефона будет проброшен в amoCRM том виде в каком он поступил на АТС.(Рекомендуется средствами АТС приводить все входящие номера телефонов к единому формату). 
    * При звонке по клику из amoCRM на АТС поступает номер телефона записанный из карточки сущности amoCRM. Необходимо чтобы АТС умела набирать этот номер (в этом формате) в линию.
    * Для корректной работы интеграции настройки на АТС которые не указаны в данной инструкции мы рекомендуем оставить по умолчанию. 
    * Интеграция не работает с модулем FreePBX «Ring Groups», вместо «Ring Groups» необходимо использовать «Queues»

Интеграция осуществляется при помощи подключения облачного сервиса Callbee к АТС при помощи Asterisk Managment Interface (AMI) посредством TCP протокола. AMI принимает подключения, устанавливаемые на сетевой порт (по умолчанию - TCP порт 5038)

## Сетевые настройки

Для того чтобы сервис Callbee мог подключится к вашей АТС, у вас обязательно должен быть «белый» статический IP адрес либо доменное имя с __A__ записью на ваш IP адрес, и проброшены через __NAT__ к АТС следующие два порта:

* внешний порт (например 35038) на порт 5038 TCP - для доступа к АТС по AMI (Замечание по   безопасности! Рекомендуем открывать порт разрешив подключение с IP адресов указанных в [списке](/#ip))
* внешний порт (например 38080) на порт 80 TCP (стандартный порт веб - сервера АТС) - для выгрузки записей разговоров

Интерфейс настройки проброса портов сильно отличается в зависимости от используемого в вашей сети маршрутизатора. Актуальную инструкцию по пробросу портов под ваш маршрутизатор вы можете найти в интернете.

### Настройка AMI Asterisk

Создать можно двумя способами:

* Способ 1 через __CLI__:

    В файле __/etc/asterisk/manager_custom.conf__ добавить например
    ```
    [callbee] 
    secret=password
    deny=0.0.0.0/0.0.0.0 
    permit=127.0.0.1/255.255.255.0
    permit=89.108.65.246/255.255.255.255
    permit=31.24.92.54/255.255.255.255
    read=system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message
    write=system,call,log,verbose,command,agent,user,config,command,dtmf,reporting,cdr,dialplan,originate,message
    writetimeout = 500
    ```

    Выполнить команду
    ```bash
    asterisk -rx "manager reload"
    ```

* Способ 2 через интерфейс __FreePBX__:
    1. Должен быть установлен модуль __Asterisk API__
    2. Выбрать меню __Settings__ -> __Asterisk Manager Users__(1) -> __Add Manager__(2)
    ![settings-asterisk-1](../img/asterisk/asterisk-1.png)
    3. Во вкладке __General__ заполнить поля как на примере
    ![settings-asterisk-2](../img/asterisk/asterisk-2.png)
    4. Во вкладке __Permissions__ установить все переключатели в положение __Yes__
    ![settings-asterisk-3](../img/asterisk/asterisk-3.png)

### Настройка Входящей маршрутизации (Inbound Routes) в FreePBX

Пример стандартной настройки
![settings-asterisk-4](../img/asterisk/asterisk-4.png)

Выставить задержку на маршрутах, для определения контакта в amoCRM __Advanced__ -> __Pause Before Answer__ (например 1 сек), c ростом базы контактов в amoCRM возможно задержку необходимо увеличить
![settings-asterisk-5](../img/asterisk/asterisk-5.png)

Включаем записи разговоров на маршрутах __Other__ -> __Call Recording__ -> __Yes__
![settings-asterisk-6](../img/asterisk/asterisk-6.png)

### Настройка Внутренних номеров (Extensions) в FreePBX

Пример настройки внутреннего номера 222:

* Есть поддержка драйвера __PJSIP__ и __CHAN_SIP__
* __Outbound CID__ оставить по умолчанию
![settings-asterisk-7](../img/asterisk/asterisk-7.png)
* настройку записей разговоров оставить по умолчанию (записи записываются на маршрутах)
![settings-asterisk-8](../img/asterisk/asterisk-8.png)

## Подключение интеграции на стороне сервиса Callbee

После проведения всех настроек описанных выше необходимо произвести
подключение сервиса.

В личном кабинете сервиса Callbee для интеграции с amoCRM необходимо

* Во вкладке __Integration__ нажить на кнопку __Install integration__ и
выбрать вкладку __AMOCRM WITH ASTERISK__ либо нажать кнопку __Install__ на
блоке с типом интеграции __AMOCRM WITH ASTERISK__
* Заполнить все необходимые пункты для интеграции.

В поле amoCRM Domain обязательно необходимо внести ваш домен amoCRM
(например, callbee.amocrm.ru без https://).

amoCRM TOKEN - Токен для соединения с AmoCRM, этот токен необходимо будет вставить в интеграцию
на стороне AmoCRM (токен должен быть из 12 символов, правее есть кнопка генерации токена). Настройка интеграции на стороне AmoCRM описана далее.
Google Chrome TOKEN - Токен для соединения с расширением в браузере Google Chrome, этот токен необходимо будет вставить в параметрах расширения (токен должен быть из 12 символов, правее есть кнопка генерации токена). Настройка расширения описана далее.
Asterisk AMI Host/Port/Username/Secret - Настройка подключения по AMI к ATC (IP-адрес сервера или доменное имя, порт, имя пользователя, пароль).
Record URL - Ссылка для записей разговоров (ссылка пробрасывается в CRM систему). Ignore lines(DID) numbers - DID номер(а) через запятую на входящим маршруте (интеграция будет игнорировать эти входящие маршруты).
Outgoing calls (all lines) - При исходящем звонке создавать «Неразобранное», «Контакт», «Контакт + Сделка».

Далее указываются настройки для линии (DID). В стандартной версии настройки применяются ко всем линиям по умолчанию. В Pro версии есть возможность устанавливать настройки для каждой линии индивидуально.

Line (DID) - Номер подразделения отдела; номер для входящих звонков, который относится к подразделению/отделу (номер берется из настроек FreePBX поля DID и доступно для редактирования только в Pro версии).
*Скриншот из FreePBX*

Description - Описание линии (DID) будет заполнять поле "Линия" в карточке Контакта и Сделки, если оставить поле Description пустым, будет проброшен номер линии (DID) (доступно для редактирования только в Pro версии). amoCRM pepline - Воронка в amoCRM. На момент создания интеграции по умолчанию выбирается основная воронка (Main), т.к. еще нет связи интеграции и amoCRM. Далее при корректном подключении интеграции при редактировании можно будет указать необходимую воронку из имеющихся.  amoCRM user ID for missed calls - ID пользователя в amoCRM для пропущенных вызовов (ответственный пользователь за пропущенные вызовы для новых клиентов, которых нет в amoCRM, например).

Smart call (by time) - Включение умной маршрутизации (перевод звонка на ответственного сотрудника) с указанием времени работы. Incoming call - При входящем звонке создавать «Неразобранное», «Контакт», «Контакт + Сделка». Unsorted during a phone call - Создание неразобранного в amoCRM в момент ответа на входящий звонок. Repeat sales mode - Настройка автоматической регистрации повторных сделок. При повторном обращении клиента в поле "Повторное обращение" будет указано значение "Повторное". Если данная настройка отключена, поле "Повторное обращение" можно скрыть.

III. Нажать кнопку « Save» и дождаться завершения подключения.

## Подключение интеграции на стороне amoCRM

4.1 В настройках amoCRM, выбрать пункт «Интеграции», в разделе
    «Телефония» найти интеграцию «Callbee», согласившись с условиями
    нажать на кнопку «Установить»

5.2  Далее необходимо прописать внутренние номера сотрудников. 3.3 В
    поле «Callbee токен» указать уникальный токен скопировав из личного
    кабинета «Callbee»

6.4 Интеграция будет работать только для внутренних номеров, которые
    вы указали у сотрудников.

7.5 Сохранить настройки.

8.7 В личном кабинете сервиса «Callbee» после всех настроек на стороне
    amoCRM необходимо перезагрузить интеграцию.

## Подключение и настройка расширения в браузере Google Chrome

Расширение __Callbee__ в google chrome используется для оповещения сотрудника о поступающих вызовах.

Установка:

* В магазине google chrome находим расширение __Callbee__ и устанавливаем его.
* Либо перейти по [ссылке](https://chrome.google.com/webstore/detail/callbee/belkefpbaepibinolmlpohpggbkiogco?hl=ru) и установить.

Настройка:
![settings-google-chrome](../img/asterisk/google-chrome.png)

* __New version__ - Отметить пункт (обязательно).
* __Click on the card to open a new tab in the browser__ - Переход в карточку контакта по клику всплывающей карточки в новой вкладке браузера, по необходимости.
* __Extension number__ - Внутренний номер телефона сотрудника.
* __Server or token__ - Уникальный токен, необходимо скопировать из пункта __GOOGLE CHROME EXTENSION TOKEN__ из настроек вашей интеграции в личном кабинете.
* Сохраняем настройки.

Статус расширения:

__ON__ - работает умная маршрутизация, отображаются оповещения

__OFF__ - отключены все оповещения, не работает умная маршрутизация

На данном этапе настройка считается выполненной.
